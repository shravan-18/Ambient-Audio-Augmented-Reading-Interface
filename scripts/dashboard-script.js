const books = {
    book1: {
        title: "Pride and Prejudice",
        chapters: [
            {
                title: "Chapter 1: A New Arrival in Meryton",
                page: `It is a truth universally acknowledged, that a single man in possession of a good fortune, must be in want of a wife.
                The Bennet household is in a flurry of excitement as news spreads that Mr. Bingley, a wealthy bachelor, has rented Netherfield Park. Mrs. Bennet is particularly anxious, already scheming for one of her five daughters to marry the eligible man. Mr. Bennet, much more reserved, teases his wife by pretending to have no interest in making Mr. Bingley's acquaintance.

                "My dear Mr. Bennet," said his lady to him, "have you heard that Netherfield Park is let at last?"
                Mr. Bennet, always reserved in his responses, listens quietly. Mrs. Bennet continues in her flurry of excitement, hoping that this man will be the solution to their daughter's futures.
                
                The story begins by focusing on the social pressures of marriage and the importance of securing a good match. Mr. Bingley's arrival is significant, as it sets in motion a series of events that will deeply impact the Bennet family.`
            },
            {
                title: "Chapter 2: The Meryton Ball",
                page: `The Meryton Ball is one of the most anticipated social events of the season. The Bennet family attends, with Mrs. Bennet eager to show off her daughters to Mr. Bingley. Bingley quickly becomes enamored with Jane Bennet, the eldest daughter, whose beauty and charm captivate him.

                However, Mr. Darcy, Bingley’s friend, stands aloof, observing the crowd with disdain. When asked by Bingley if he would like to dance with Elizabeth Bennet, Darcy haughtily replies, “She is tolerable, but not handsome enough to tempt me.”
                
                Elizabeth overhears this slight and is both amused and insulted. This sets the stage for the complicated relationship that will develop between Elizabeth and Darcy throughout the novel. Darcy's initial arrogance contrasts with Elizabeth's intelligence and wit, making their eventual romance all the more satisfying.`
            },
            {
                title: "Chapter 3: Elizabeth and Darcy’s Clash",
                page: `Elizabeth Bennet’s sharp wit and Darcy’s pride clash as they meet more frequently at various social events. Darcy, despite his initial coldness, finds himself drawn to Elizabeth's independence and wit. However, his inability to lower his social guard and Elizabeth’s growing dislike for his arrogance create tension.

                Elizabeth, meanwhile, meets Mr. Wickham, a charming young officer who claims to have been wronged by Darcy. Wickham’s story further confirms Elizabeth’s negative view of Darcy, solidifying her prejudice against him. 

                The chapter builds on the theme of misjudgment and the consequences of first impressions. Darcy’s pride and Elizabeth’s prejudice against him begin to manifest, laying the groundwork for their eventual understanding and growth.`
            },
            {
                title: "Chapter 4: Jane’s Illness at Netherfield",
                page: `When Jane is invited to dine at Netherfield, Mrs. Bennet, always scheming, insists that she go on horseback rather than by carriage, in hopes that it will rain and Jane will be forced to stay longer. Unfortunately, Jane catches a cold and must indeed stay at Netherfield.

                Elizabeth walks to Netherfield to care for her sister, staying as a guest in the house. This chapter deepens the tension between Elizabeth and Darcy, as they are now under the same roof. Darcy continues to observe Elizabeth, becoming more attracted to her, while Elizabeth’s dislike for Darcy solidifies due to Wickham’s tale of Darcy’s supposed wrongdoing.`
            }
        ]
    },
    book2: {
        title: "The Adventures of Sherlock Holmes",
        chapters: [
            {
                title: "Chapter 1: A Scandal in Bohemia",
                page: `To Sherlock Holmes she is always the woman. I have seldom heard him mention her under any other name. In his eyes she eclipses and predominates the whole of her sex.

                In this first adventure, Holmes is called upon by the King of Bohemia to recover a compromising photograph from the brilliant and beautiful Irene Adler. Despite all his cunning, Holmes is outwitted by Adler, who leaves England with the photograph, leaving behind only a letter for Holmes. This chapter sets the tone for the rest of the series, showcasing Holmes' unparalleled intellect and the rare individual who manages to outmaneuver him.`
            },
            {
                title: "Chapter 2: The Adventure of the Speckled Band",
                page: `This case involves a young woman, Helen Stoner, who seeks Holmes’ help after her twin sister dies under mysterious circumstances. Helen fears for her own life, as strange occurrences, such as hearing a whistling sound at night, have begun to plague her.

                Holmes uncovers the nefarious plot of Dr. Grimesby Roylott, Helen’s stepfather, who had been using a deadly snake—the “speckled band”—to kill his stepdaughters and secure their inheritance. Holmes’ quick thinking saves Helen’s life, but not before a final deadly encounter with the snake. This story is one of the more suspenseful cases, showing Holmes’ brilliance in deducing a complex and life-threatening situation.`
            },
            {
                title: "Chapter 3: The Red-Headed League",
                page: `In this amusing yet mysterious case, Holmes is approached by a pawnbroker named Jabez Wilson, who has been tricked into joining a strange organization called the Red-Headed League, which turns out to be a ruse to get Wilson out of his shop for long periods. 

                Holmes quickly deduces that the true motive behind the League is to gain access to the bank next to Wilson’s shop, through a tunnel being dug by criminals. Holmes foils the bank robbery just in time, demonstrating his unparalleled deductive reasoning and swift action.`
            },
            {
                title: "Chapter 4: The Adventure of the Blue Carbuncle",
                page: `Holmes’ brilliant deduction abilities are on full display in this case, which begins with a simple Christmas goose. A man loses both his hat and his goose in the street, and when the goose is cut open, a priceless blue gem, the stolen Blue Carbuncle, is found inside.

                Holmes traces the gem back to a series of events involving the theft of the carbuncle from a noblewoman’s hotel room. With his characteristic wit and calm demeanor, Holmes brings the culprit to justice, though in an unusual act of mercy, he lets the thief go. This chapter exemplifies Holmes’ sense of justice and his belief that not all criminals deserve the same punishment.`
            }
        ]
    },
    book3: {
        title: "Dracula",
        chapters: [
            {
                title: "Chapter 1: Jonathan Harker’s Journal",
                page: `Jonathan Harker, a young English solicitor, travels to Transylvania to meet with a mysterious nobleman, Count Dracula, who wishes to purchase an estate in England. As Harker approaches the Count’s castle, he begins to notice strange and unsettling things. The locals react with fear when they hear of his destination, and he starts to receive warnings about staying away from the castle.

                Upon arriving, Harker finds Count Dracula to be a polite but unsettling figure. Harker’s unease grows as he explores the castle and discovers that he is essentially a prisoner. His journal entries become more frantic as he realizes that Dracula is far more than he seems—a creature of unspeakable horror.`
            },
            {
                title: "Chapter 2: The Shipwreck at Whitby",
                page: `Back in England, the story shifts to the coastal town of Whitby, where a mysterious shipwreck occurs. A ship arrives without a living crew, only a dead captain tied to the wheel. A strange black dog is seen leaping from the wreck and disappearing into the night. This marks Dracula's arrival in England.

                Lucy Westenra, a beautiful young woman, begins to suffer from strange bouts of illness after sleepwalking near the site of the shipwreck. Unbeknownst to her, she has become the target of Dracula’s vampiric influence. Her slow decline forms the basis for much of the novel’s early tension.`
            },
            {
                title: "Chapter 3: Van Helsing Arrives",
                page: `As Lucy’s condition worsens, her fiancé, Arthur Holmwood, calls upon his old friend, Dr. Abraham Van Helsing, to assist with her mysterious illness. Van Helsing is an experienced doctor and scientist, but he also possesses knowledge of supernatural phenomena.

                Van Helsing quickly suspects that Lucy is under the influence of a vampire but faces skepticism from the others. As Lucy’s condition continues to deteriorate, Van Helsing begins to employ strange and unorthodox methods, such as placing garlic around her room, to ward off the vampire’s attacks. Despite his efforts, Lucy succumbs to Dracula’s power and becomes a vampire herself.`
            },
            {
                title: "Chapter 4: Lucy’s Transformation",
                page: `After Lucy’s death, she begins to prey upon children in the area, earning her the nickname “The Bloofer Lady” among the local population. Van Helsing, Arthur, and the others resolve to put an end to her vampiric existence.

                In a heartbreaking scene, Arthur must drive a stake through Lucy’s heart to release her from her undead state. This chapter is crucial in illustrating the horror and tragedy of vampirism, as well as the emotional toll it takes on those who love the victim. It also marks the beginning of the group’s quest to stop Dracula before he claims more victims.`
            }
        ]
    },
    book4: {
        title: "Moby-Dick",
        chapters: [
            {
                title: "Chapter 1: Loomings",
                page: `Call me Ishmael. Some years ago—never mind how long precisely—having little or no money in my purse, and nothing particular to interest me on shore, I thought I would sail about a little and see the watery part of the world. It is this famous opening line that introduces the reader to Ishmael, the narrator of Moby-Dick.

                Ishmael, tired of life on land, decides to join a whaling voyage. He travels to New Bedford, Massachusetts, where he meets Queequeg, a harpooner from the South Seas. Despite their initial differences, the two become fast friends and agree to sail together on a whaling ship. This chapter sets the stage for the larger narrative of the Pequod’s doomed voyage in search of the great white whale.`
            },
            {
                title: "Chapter 2: Aboard the Pequod",
                page: `Ishmael and Queequeg sign on to the whaling ship Pequod, under the command of Captain Ahab. The crew is an eclectic mix of men from all over the world, and the ship itself has a mysterious, almost ominous air.

                As the ship prepares to set sail, Ishmael hears whispers of Ahab’s obsession with a legendary white whale named Moby-Dick, who had previously taken Ahab’s leg in a brutal encounter. Ahab’s quest for revenge becomes the central driving force of the novel. The chapter builds a sense of foreboding as the ship embarks on its fateful journey.`
            },
            {
                title: "Chapter 3: The Chase Begins",
                page: `Once at sea, it becomes clear that Captain Ahab is singularly focused on one thing: finding and killing Moby-Dick. Ahab offers a gold doubloon as a reward to the first man who sights the white whale, and the crew becomes caught up in his obsessive quest.

                Despite warnings from other ships they encounter, Ahab presses forward, driven by a desire for vengeance. The crew begins to realize that Ahab’s obsession may lead them to their doom, but they are powerless to stop him. The chapter highlights Ahab’s monomaniacal nature and the growing tension aboard the ship.`
            },
            {
                title: "Chapter 4: Moby-Dick Appears",
                page: `At last, after months at sea, the great white whale, Moby-Dick, is sighted. The crew prepares for the final confrontation, but the whale proves to be a formidable opponent. Ahab’s desire for revenge blinds him to the dangers, and he pushes the crew and the ship to their limits.

                In a dramatic and chaotic final battle, Moby-Dick destroys the Pequod, killing most of the crew. Ahab, in his final moments, is caught in the whale’s ropes and dragged into the depths of the ocean. Ishmael, the sole survivor, is left adrift, floating on Queequeg’s coffin until he is rescued. The novel ends with a meditation on the destructive power of obsession and the unpredictability of nature.`
            }
        ]
    }
};

function openBook(bookId) {
    currentBook = books[bookId];
    currentChapterIndex = 0;
    showChapter();
    document.getElementById('bookModal').style.display = 'flex';
    loadProgress(bookId);
}

let currentBook = null;
let currentChapterIndex = 0;
let speech = null;
let isSpeaking = false;
let isPaused = false;
let currentText = '';
let currentPosition = 0;
let speechRate = 1;
let speechVolume = 1; // Add volume control variable

function showChapter() {
    const chapter = currentBook.chapters[currentChapterIndex];
    document.getElementById('book-title').innerText = currentBook.title;
    document.getElementById('chapter-title').innerText = chapter.title;
    
    // Set the text content and prepare for highlighting
    const pageContent = document.getElementById('page-content');
    pageContent.innerHTML = `
        <span class="before"></span>
        <span class="highlight"></span>
        <span class="after">${chapter.page}</span>
    `;
    
    // Toggle visibility of next/previous buttons
    const prevButton = document.querySelector('.controls button:first-of-type');
    prevButton.style.display = currentChapterIndex === 0 ? 'none' : 'inline-block';
    const nextButton = document.querySelector('.controls button:last-of-type');
    nextButton.style.display = currentChapterIndex === currentBook.chapters.length - 1 ? 'none' : 'inline-block';

    // Initialize speech controls if they don't exist
    initializeSpeechControls();
    
    // Reset speech state when changing chapters
    stopSpeech();
    updateSpeakerButton();
    
    saveProgress();
}

function initializeSpeechControls() {
    const buttonContainer = document.querySelector('.button-container');
    const existingControls = document.querySelector('.speech-controls');
    
    if (!existingControls) {
        const speechControls = document.createElement('div');
        speechControls.className = 'speech-controls';
        speechControls.innerHTML = `
            <div class="control-container">
                <div class="control-label">Volume</div>
                <div class="slider-container">
                    <button class="control-btn" onclick="adjustVolume(-0.1)">
                        <span>-</span>
                    </button>
                    <input 
                        type="range" 
                        id="volume-slider" 
                        min="0" 
                        max="1" 
                        step="0.1" 
                        value="${speechVolume}"
                    />
                    <button class="control-btn" onclick="adjustVolume(0.1)">
                        <span>+</span>
                    </button>
                </div>
            </div>
            <div class="control-container">
                <div class="control-label">Speed</div>
                <div class="slider-container">
                    <button class="control-btn" onclick="adjustRate(-0.25)">
                        <span>-</span>
                    </button>
                    <input 
                        type="range" 
                        id="rate-slider" 
                        min="0.5" 
                        max="2" 
                        step="0.25" 
                        value="${speechRate}"
                    />
                    <button class="control-btn" onclick="adjustRate(0.25)">
                        <span>+</span>
                    </button>
                </div>
                <div class="rate-display">${speechRate}x</div>
            </div>
        `;
        buttonContainer.appendChild(speechControls);

        // Add event listeners
        const volumeSlider = document.getElementById('volume-slider');
        volumeSlider.addEventListener('input', function(e) {
            setVolume(parseFloat(e.target.value));
        });

        const rateSlider = document.getElementById('rate-slider');
        rateSlider.addEventListener('input', function(e) {
            setRate(parseFloat(e.target.value));
        });
    }
}

function updateHighlight(position, length = 1) {
    const pageContent = document.getElementById('page-content');
    if (!pageContent) return;

    const beforeSpan = pageContent.querySelector('.before');
    const highlightSpan = pageContent.querySelector('.highlight');
    const afterSpan = pageContent.querySelector('.after');

    if (beforeSpan && highlightSpan && afterSpan && currentText) {
        beforeSpan.textContent = currentText.substring(0, position);
        highlightSpan.textContent = currentText.substring(position, position + length);
        afterSpan.textContent = currentText.substring(position + length);
    }
}

function readAloud() {
    if (!window.speechSynthesis) {
        alert("Sorry, your browser doesn't support text to speech!");
        return;
    }

    if (isPaused) {
        resumeSpeech();
    } else if (isSpeaking) {
        pauseSpeech();
    } else {
        startNewSpeech();
    }

    updateSpeakerButton();
}

function startNewSpeech() {
    const pageContent = document.getElementById('page-content');
    if (!pageContent) return;

    currentText = pageContent.textContent;
    currentPosition = 0;

    // Reset the content with spans for highlighting
    pageContent.innerHTML = `
        <span class="before"></span>
        <span class="highlight"></span>
        <span class="after">${currentText}</span>
    `;

    speakFromPosition(currentPosition);

    isSpeaking = true;
    isPaused = false;
}

function initializeVolumeControls() {
    const buttonContainer = document.querySelector('.button-container');
    const existingControls = document.querySelector('.volume-controls');
    
    if (!existingControls) {
        const volumeControls = document.createElement('div');
        volumeControls.className = 'volume-controls';
        volumeControls.innerHTML = `
            <div class="volume-slider-container">
                <button class="volume-btn" onclick="adjustVolume(-0.1)">
                    <span>-</span>
                </button>
                <input 
                    type="range" 
                    id="volume-slider" 
                    min="0" 
                    max="1" 
                    step="0.1" 
                    value="${speechVolume}"
                />
                <button class="volume-btn" onclick="adjustVolume(0.1)">
                    <span>+</span>
                </button>
            </div>
        `;
        buttonContainer.appendChild(volumeControls);

        // Add event listener to volume slider
        const volumeSlider = document.getElementById('volume-slider');
        volumeSlider.addEventListener('input', function(e) {
            setVolume(parseFloat(e.target.value));
        });
    }
}

function setVolume(value) {
    speechVolume = Math.max(0, Math.min(1, value));
    if (speech) {
        speech.volume = speechVolume;
    }
    // Update slider position
    const slider = document.getElementById('volume-slider');
    if (slider) {
        slider.value = speechVolume;
    }
}

function adjustVolume(change) {
    setVolume(speechVolume + change);
}

function setRate(value) {
    speechRate = Math.max(0.5, Math.min(2, value));
    if (speech) {
        speech.rate = speechRate;
    }
    // Update slider position and display
    const slider = document.getElementById('rate-slider');
    const display = document.querySelector('.rate-display');
    if (slider) {
        slider.value = speechRate;
    }
    if (display) {
        display.textContent = `${speechRate.toFixed(2)}x`;
    }
}

function adjustRate(change) {
    setRate(speechRate + change);
}

function speakFromPosition(position) {
    position = Math.max(0, Math.min(position, currentText.length));
    const remainingText = currentText.substring(position);

    if (speech) {
        window.speechSynthesis.cancel();
    }

    speech = new SpeechSynthesisUtterance(remainingText);
    speech.rate = speechRate;
    speech.volume = speechVolume; // Set the volume
    speech.pitch = 1;

    speech.onboundary = function(event) {
        if (event.name === 'word') {
            currentPosition = position + event.charIndex;
            updateHighlight(currentPosition, event.charLength || event.length || 1);
        }
    };

    speech.onend = function() {
        if (!isPaused) {
            stopSpeech();
        }
    };

    window.speechSynthesis.speak(speech);
}

function pauseSpeech() {
    if (speech && isSpeaking) {
        window.speechSynthesis.pause();
        isPaused = true;
        isSpeaking = false;
    }
}

function resumeSpeech() {
    if (isPaused && currentText) {
        window.speechSynthesis.resume();
        isSpeaking = true;
        isPaused = false;
    }
}

function stopSpeech() {
    window.speechSynthesis.cancel();
    speech = null;
    isSpeaking = false;
    isPaused = false;
    currentPosition = 0;
    
    // Reset the page content
    const pageContent = document.getElementById('page-content');
    if (pageContent && currentBook && currentBook.chapters) {
        const chapter = currentBook.chapters[currentChapterIndex];
        pageContent.innerHTML = chapter.page;
    }
    
    updateSpeakerButton();
}

function updateSpeakerButton() {
    const speakerButton = document.querySelector('.speaker-button');
    if (speakerButton) {
        if (isSpeaking) {
            speakerButton.innerHTML = 'Pause';
        } else if (isPaused) {
            speakerButton.innerHTML = 'Resume';
        } else {
            speakerButton.innerHTML = 'Read Aloud';
        }
    }
}

function setSpeed(rate) {
    speechRate = rate;
    if (speech) {
        speech.rate = rate;
    }
}

function closeModal() {
    document.getElementById('bookModal').style.display = 'none';
    stopSpeech();
}

function previousPage() {
    if (currentChapterIndex > 0) {
        currentChapterIndex--;
        showChapter();
        saveProgress();
    }
}

function nextPage() {
    if (currentChapterIndex < currentBook.chapters.length - 1) {
        currentChapterIndex++;
        showChapter();
        saveProgress();
    }
}

function saveProgress() {
    if (!currentBook) return;
    
    const progress = ((currentChapterIndex + 1) / currentBook.chapters.length) * 100;
    const bookId = sanitizeBookTitle(currentBook.title);
    localStorage.setItem(currentBook.title + '_progress', currentChapterIndex);
    
    const progressElement = document.getElementById(bookId + '-progress');
    if (progressElement) {
        progressElement.innerText = `progress ${progress.toFixed(0)}%`;
    }
}

function loadProgress(bookId) {
    if (!books[bookId]) return;
    
    const storedProgress = localStorage.getItem(books[bookId].title + '_progress');
    const progressElement = document.getElementById(bookId + '-progress');
    
    if (storedProgress && progressElement) {
        const progress = ((parseInt(storedProgress) + 1) / books[bookId].chapters.length) * 100;
        progressElement.innerText = `progress ${progress.toFixed(0)}%`;
    }
}

function sanitizeBookTitle(title) {
    if (!title) return '';
    return title
        .toLowerCase()
        .replace(/\s+/g, '')
        .replace(/[^a-z0-9]/g, '');
}
const userData = {
    name: "John Smith",
    age: 28,
    favoriteGenres: ["Mystery", "Science Fiction", "Classic Literature"]
};

// Profile modal functionality
function showProfileModal() {
    const modal = document.createElement('div');
    modal.className = 'profile-modal';
    modal.innerHTML = `
        <div class="profile-content">
            <span class="close-profile">&times;</span>
            <div class="profile-header">
                <img src="css/img/User_circle.svg" alt="Profile" class="profile-avatar">
                <h2>User Profile</h2>
            </div>
            <div class="profile-info">
                <p><strong>Name:</strong> ${userData.name}</p>
                <p><strong>Age:</strong> ${userData.age}</p>
                <p><strong>Favorite Genres:</strong></p>
                <ul>
                    ${userData.favoriteGenres.map(genre => `<li>${genre}</li>`).join('')}
                </ul>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // Close button functionality
    const closeBtn = modal.querySelector('.close-profile');
    closeBtn.onclick = function() {
        modal.remove();
    };

    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target === modal) {
            modal.remove();
        }
    };
}

// Add event listener to profile icon
document.addEventListener('DOMContentLoaded', function() {
    const profileButton = document.querySelector('.profile-icon');
    profileButton.addEventListener('click', showProfileModal);
});

